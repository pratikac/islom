\newcommand\PYZat{@}
\newcommand\PYZlb{[}
\newcommand\PYZrb{]}
\newcommand\PYbh[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
\newcommand\PYbg[1]{\textcolor[rgb]{0.73,0.40,0.53}{\textbf{#1}}}
\newcommand\PYbf[1]{\textcolor[rgb]{0.82,0.25,0.23}{\textbf{#1}}}
\newcommand\PYbe[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYbd[1]{\textcolor[rgb]{0.73,0.13,0.13}{#1}}
\newcommand\PYbc[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
\newcommand\PYbb[1]{\textcolor[rgb]{0.00,0.50,0.00}{#1}}
\newcommand\PYba[1]{\textcolor[rgb]{0.00,0.00,0.50}{\textbf{#1}}}
\newcommand\PYaJ[1]{\textcolor[rgb]{0.69,0.00,0.25}{#1}}
\newcommand\PYaK[1]{\textcolor[rgb]{0.73,0.13,0.13}{#1}}
\newcommand\PYaH[1]{\textcolor[rgb]{0.50,0.00,0.50}{\textbf{#1}}}
\newcommand\PYaI[1]{\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{#1}}
\newcommand\PYaN[1]{\textcolor[rgb]{0.74,0.48,0.00}{#1}}
\newcommand\PYaO[1]{\textcolor[rgb]{0.00,0.00,1.00}{\textbf{#1}}}
\newcommand\PYaL[1]{\textcolor[rgb]{0.00,0.00,1.00}{#1}}
\newcommand\PYaM[1]{\textcolor[rgb]{0.73,0.73,0.73}{#1}}
\newcommand\PYaB[1]{\textcolor[rgb]{0.73,0.13,0.13}{#1}}
\newcommand\PYaC[1]{\textcolor[rgb]{0.67,0.13,1.00}{#1}}
\newcommand\PYaA[1]{\textcolor[rgb]{0.00,0.50,0.00}{#1}}
\newcommand\PYaF[1]{\textcolor[rgb]{0.63,0.00,0.00}{#1}}
\newcommand\PYaG[1]{\textcolor[rgb]{1.00,0.00,0.00}{#1}}
\newcommand\PYaD[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
\newcommand\PYaE[1]{\textcolor[rgb]{0.25,0.50,0.50}{\textit{#1}}}
\newcommand\PYaZ[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
\newcommand\PYaX[1]{\textcolor[rgb]{0.00,0.50,0.00}{#1}}
\newcommand\PYaY[1]{\textcolor[rgb]{0.73,0.13,0.13}{#1}}
\newcommand\PYaR[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYaS[1]{\textcolor[rgb]{0.10,0.09,0.49}{#1}}
\newcommand\PYaP[1]{\textcolor[rgb]{0.00,0.00,0.50}{\textbf{#1}}}
\newcommand\PYaQ[1]{\textcolor[rgb]{0.49,0.56,0.16}{#1}}
\newcommand\PYaV[1]{\textcolor[rgb]{0.00,0.00,1.00}{\textbf{#1}}}
\newcommand\PYaW[1]{\textcolor[rgb]{0.73,0.13,0.13}{#1}}
\newcommand\PYaT[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYaU[1]{\textcolor[rgb]{0.25,0.50,0.50}{\textit{#1}}}
\newcommand\PYaj[1]{\textcolor[rgb]{0.00,0.50,0.00}{#1}}
\newcommand\PYak[1]{\textcolor[rgb]{0.73,0.40,0.53}{#1}}
\newcommand\PYah[1]{\textcolor[rgb]{0.63,0.63,0.00}{#1}}
\newcommand\PYai[1]{\textcolor[rgb]{0.10,0.09,0.49}{#1}}
\newcommand\PYan[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYao[1]{\textcolor[rgb]{0.73,0.40,0.13}{\textbf{#1}}}
\newcommand\PYal[1]{\textcolor[rgb]{0.25,0.50,0.50}{\textit{#1}}}
\newcommand\PYam[1]{\textbf{#1}}
\newcommand\PYab[1]{\textit{#1}}
\newcommand\PYac[1]{\textcolor[rgb]{0.73,0.13,0.13}{#1}}
\newcommand\PYaa[1]{\textcolor[rgb]{0.50,0.50,0.50}{#1}}
\newcommand\PYaf[1]{\textcolor[rgb]{0.25,0.50,0.50}{\textit{#1}}}
\newcommand\PYag[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYad[1]{\textcolor[rgb]{0.00,0.25,0.82}{#1}}
\newcommand\PYae[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYaz[1]{\textcolor[rgb]{0.00,0.63,0.00}{#1}}
\newcommand\PYax[1]{\textcolor[rgb]{0.60,0.60,0.60}{\textbf{#1}}}
\newcommand\PYay[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
\newcommand\PYar[1]{\textcolor[rgb]{0.10,0.09,0.49}{#1}}
\newcommand\PYas[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{#1}}}
\newcommand\PYap[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
\newcommand\PYaq[1]{\textcolor[rgb]{0.53,0.00,0.00}{#1}}
\newcommand\PYav[1]{\textcolor[rgb]{0.67,0.13,1.00}{\textbf{#1}}}
\newcommand\PYaw[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\newcommand\PYat[1]{\textcolor[rgb]{0.10,0.09,0.49}{#1}}
\newcommand\PYau[1]{\textcolor[rgb]{0.10,0.09,0.49}{#1}}

\section*{}
{
\footnotesize{
\begin{Verbatim}[commandchars=@\[\]]
@PYaJ[signed] @PYaJ[int] accelRead(@PYaJ[unsigned] @PYaJ[int] addr);
@PYaJ[signed] @PYaJ[int] gyroRead(@PYaJ[unsigned] @PYaJ[int] addr);

@PYay[volatile] @PYaJ[int] newData @PYbe[=] FALSE;
@PYay[volatile] INT16 tiltX;
@PYay[volatile] INT16 tiltY;
@PYay[volatile] INT16 tilt;
@PYay[volatile] INT16 gRead;

@PYaE[// Kalman filter variables]
@PYaN[#]@PYaN[define GYRO_SCALE              (0.07326)]
@PYaN[#]@PYaN[define ACCEL_SCALE             (0.0004625)]
@PYaN[#]@PYaN[define gravity                 (9.806)]
@PYaN[#]@PYaN[define FSAMP                   (10)]
@PYaN[#]@PYaN[define RAD2DEG                 (180.0]@PYaN[/]@PYaN[3.1415)]

@PYaE[// 10.6]
@PYay[volatile] INT16 GYRO_MULT @PYbe[=] GYRO_SCALE@PYbe[*]@PYaw[64.0];
@PYay[volatile] INT16 TILT_MULT @PYbe[=] @PYaw[0.1]@PYbe[*]@PYaw[64.0];

@PYaE[// Persistant states (10.6) -- covaraince is < 1]
@PYay[volatile] INT16 P_00 @PYbe[=] @PYaw[64.0];
@PYay[volatile] INT16 P_01 @PYbe[=] @PYag[0];
@PYay[volatile] INT16 P_10 @PYbe[=] @PYag[0];
@PYay[volatile] INT16 P_11 @PYbe[=] @PYaw[64.0];

@PYaE[// Constants (10.6)]
@PYay[volatile] INT16 A_01 @PYbe[=] @PYaw[64.0]@PYbe[/]FSAMP;
@PYay[volatile] INT16 B_00 @PYbe[=] @PYaw[64.0]@PYbe[/]FSAMP;

@PYaE[// Accelerometer variance (10.6) = 22*ACCEL_SCALE*g]
@PYay[volatile] INT16 Sz @PYbe[=] @PYag[22]@PYbe[*]ACCEL_SCALE@PYbe[*]gravity@PYbe[*]@PYaw[64.0];

@PYaE[// Gyro variance (10.6) = 96E-6]
@PYay[volatile] INT16 Sw_00 @PYbe[=] @PYag[1];

@PYaE[// Output (10.6)]
@PYay[volatile] INT16 x_00 @PYbe[=] @PYag[0];
@PYay[volatile] INT16 x_10@PYbe[=] @PYag[0];

@PYaE[// Filter vars (all 10.6)]
@PYay[volatile] INT16 inn_00 @PYbe[=] @PYag[0], s_00 @PYbe[=] @PYag[0], AP_00 @PYbe[=] @PYag[0], AP_01 @PYbe[=] @PYag[0], AP_10 @PYbe[=] @PYag[0],
         AP_11 @PYbe[=] @PYag[0], K_00 @PYbe[=] @PYag[0], K_10 @PYbe[=] @PYag[0];
@PYay[volatile] INT16 to_send@PYZlb[]@PYag[7]@PYZrb[] @PYbe[=] {@PYag[0]};

@PYaJ[void] @PYaL[do_kalman](INT16 gRead, INT16 tilt)
{
    @PYaE[// Update the state estimate by extrapolating current state estimate with input u.]
    @PYaE[// x = A * x + B * u]
    x_00 @PYbe[=] x_00 @PYbe[+] ((INT32)((INT32)A_01 @PYbe[*] (INT32)x_10))@PYbe[/]@PYag[64] @PYbe[+] \
           ((INT32)((INT32)B_00 @PYbe[*] (INT32)gRead))@PYbe[/]@PYag[64];
    to_send@PYZlb[]@PYag[0]@PYZrb[] @PYbe[=] x_00;

    @PYaE[// Compute the innovation -- error between measured value and state.]
    @PYaE[// inn = y - c * x]
    inn_00 @PYbe[=] tilt @PYbe[-] x_00;
    to_send@PYZlb[]@PYag[1]@PYZrb[] @PYbe[=] inn_00;    

    @PYaE[// Compute the covariance of the innovation.]
    @PYaE[// s = C * P * C' + Sz]
    s_00 @PYbe[=] P_00 @PYbe[+] Sz;
    to_send@PYZlb[]@PYag[2]@PYZrb[] @PYbe[=] s_00;

    @PYaE[// Compute AP matrix for use below.]
    @PYaE[// AP = A * P]
    AP_00 @PYbe[=] P_00 @PYbe[+] ((INT32)((INT32)A_01 @PYbe[*] (INT32)P_10))@PYbe[/]@PYag[64];
    AP_01 @PYbe[=] P_01 @PYbe[+] ((INT32)((INT32)A_01 @PYbe[*] (INT32)P_11))@PYbe[/]@PYag[64];
    AP_10 @PYbe[=] P_10;
    AP_11 @PYbe[=] P_11;
    to_send@PYZlb[]@PYag[3]@PYZrb[] @PYbe[=] AP_00;
    
    @PYaE[// Compute the kalman gain matrix.]
    @PYaE[// K = A * P * C' * inv(s)]
    K_00 @PYbe[=] ((INT32)((INT32)AP_00@PYbe[*]@PYag[64])) @PYbe[/] s_00;
    K_10 @PYbe[=] ((INT32)((INT32)AP_10@PYbe[*]@PYag[64])) @PYbe[/] s_00;
    to_send@PYZlb[]@PYag[4]@PYZrb[] @PYbe[=] K_00;

    @PYaE[// Update the state estimate]
    @PYaE[// x = x + K * inn]
    x_00 @PYbe[=] x_00 @PYbe[+] ((INT32)((INT32)K_00 @PYbe[*] (INT32)inn_00))@PYbe[/]@PYag[64];
    x_10 @PYbe[=] x_10 @PYbe[+] ((INT32)((INT32)K_10 @PYbe[*] (INT32)inn_00))@PYbe[/]@PYag[64];
    to_send@PYZlb[]@PYag[5]@PYZrb[] @PYbe[=] x_00;

    @PYaE[// Compute the new covariance of the estimation error]
    @PYaE[// P = A * P * A' - K * C * P * A' + Sw]
    P_00 @PYbe[=] AP_00 @PYbe[+] ((INT32)((INT32)AP_01 @PYbe[*] (INT32)A_01) @PYbe[-] (INT32)((INT32)K_00 @PYbe[*] (INT32)P_00))@PYbe[/]@PYag[64] \
           @PYbe[+] (INT32)(((INT32)((INT32)K_00 @PYbe[*] (INT32)P_01)@PYbe[/]@PYag[64]) @PYbe[*] (INT32)A_01)@PYbe[/]@PYag[64] @PYbe[+] Sw_00;
    
    P_01 @PYbe[=] AP_01 @PYbe[-] (INT32)((INT32)K_00 @PYbe[*] (INT32)P_01)@PYbe[/]@PYag[64];
    P_10 @PYbe[=] AP_10 @PYbe[+] ((INT32)((INT32)AP_11 @PYbe[*] (INT32)A_01) @PYbe[-] (INT32)((INT32)K_10 @PYbe[*] (INT32)P_00))@PYbe[/]@PYag[64] \
           @PYbe[+] (INT32)(((INT32)((INT32)K_10 @PYbe[*] (INT32)P_01)@PYbe[/]@PYag[64]) @PYbe[*] (INT32)A_01)@PYbe[/]@PYag[64];

    P_11 @PYbe[=] AP_11 @PYbe[-] (INT32)((INT32)K_10 @PYbe[*] (INT32)P_01)@PYbe[/]@PYag[64];
}
\end{Verbatim}
}